Install CUDA driver on Ubuntu with Secure Boot enabled

With Secure Boot enabled, all Linux kernel modules are required to be signed by the key trusted by the system.

    Install pre-built Azure Linux kernel based NVIDIA modules and CUDA drivers
    Bash 

sudo apt-get update
sudo apt install -y linux-modules-nvidia-525-azure nvidia-driver-525

Change preference of NVIDIA packages to prefer NVIDIA repository
Bash

sudo tee /etc/apt/preferences.d/cuda-repository-pin-600 > /dev/null <<EOL
Package: nsight-compute
Pin: origin *ubuntu.com*
Pin-Priority: -1
Package: nsight-systems
Pin: origin *ubuntu.com*
Pin-Priority: -1
Package: nvidia-modprobe
Pin: release l=NVIDIA CUDA
Pin-Priority: 600
Package: nvidia-settings
Pin: release l=NVIDIA CUDA
Pin-Priority: 600
Package: *
Pin: release l=NVIDIA CUDA
Pin-Priority: 100
EOL

Add CUDA repository
Bash

sudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/$distro/$arch/3bf863cc.pub

Bash

sudo add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/$distro/$arch/ /"

where $distro/$arch should be replaced by one of the following:

ubuntu2004/arm64
ubuntu2004/x86_64
ubuntu2204/arm64
ubuntu2204/x86_64

If add-apt-repository command is not found, run sudo apt-get install software-properties-common to install it.

Install kernel headers and development packages, and remove outdated signing key
Bash

sudo apt-get install linux-headers-$(uname -r)
sudo apt-key del 7fa2af80

Install the new cuda-keyring package
Bash

wget https://developer.download.nvidia.com/compute/cuda/repos/$distro/$arch/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb

Note: When prompt on different versions of cuda-keyring, select Y or I : install the package maintainer's version to proceed.

Update APT repository cache and install NVIDIA GPUDirect Storage
Bash

sudo apt-get update
sudo apt-get install -y nvidia-gds

Note that during the installation you will be prompted for password when configuring secure boot, a password of your choice needs to be provided and then proceed.

Secure Boot Password Configuration

Reboot the VM
Bash

sudo reboot

Verify NVIDIA CUDA drivers are installed and loaded
Bash

dpkg -l | grep -i nvidia
nvidia-smi
